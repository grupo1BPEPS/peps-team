<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gym Routine Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #1f2933;
            color: white;
            padding: 15px;
            text-align: center;
        }
        main {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            padding: 25px;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        label {
            display: block;
            margin-top: 15px;
        }
        input, select, button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background-color: #1e40af;
        }
        .hidden { display: none; }
        .rutina {
            margin-top: 20px;
            background: #f9fafb;
            padding: 15px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<header>
    <h1>Gym Routine Generator</h1>
</header>

<main>

<!-- LOGIN -->
<section id="login-section">
    <h2>Login</h2>
    <label>Usuario</label>
    <input type="text" id="username">
    <label>Contraseña</label>
    <input type="password" id="password">
    <button onclick="login()">Entrar</button>
    <button onclick="showRegister()">Crear cuenta</button>
</section>

<!-- REGISTER -->
<section id="register-section" class="hidden">
    <h2>Registro</h2>
    <label>Usuario</label>
    <input type="text" id="username_register">
    <label>Contraseña</label>
    <input type="password" id="password_register">
    <button onclick="register()">Registrarse</button>
    <button onclick="showLogin()">Volver</button>
</section>

<!-- BUSCAR RUTINAS -->
<section id="generar-rutina-section" class="hidden">
    <h2>Buscar rutina</h2>

    <label>Objetivo</label>
    <select id="objetivo">
        <option value="fuerza">Fuerza</option>
        <option value="cardio">Cardio</option>
        <option value="hibrido">Híbrido</option>
    </select>

    <label>Nivel</label>
    <select id="nivel">
        <option value="basico">Básico</option>
        <option value="intermedio">Intermedio</option>
        <option value="avanzado">Avanzado</option>
    </select>

    <label>Días</label>
    <input type="number" id="dias" min="1" max="5">

    <button onclick="buscarRutinas()">Buscar rutinas</button>
    <button onclick="logout()">Cerrar sesión</button>

    <div id="listado-rutinas" class="rutina"></div>
</section>

<!-- MOSTRAR RUTINA -->
<section id="mostrar-rutina-section" class="hidden">
    <h2>Rutina seleccionada</h2>

    <table border="1" cellpadding="8" cellspacing="0">
        <thead>
            <tr>
                <th>Día</th>
                <th>Ejercicio</th>
                <th>Series</th>
                <th>Reps / Tiempo</th>
            </tr>
        </thead>
        <tbody id="tabla-rutina"></tbody>
    </table>

    <button onclick="guardarRutina()">Guardar rutina</button>
    <button onclick="volverBusqueda()">Volver</button>
    <button onclick="logout()">Cerrar sesión</button>
</section>

</main>

<script>
let rutinasDisponibles = [];
let rutinaSeleccionadaId = null;

/* =======================
   AUTENTICACIÓN
======================= */
function login() {
    const usernameInput = document.getElementById("username").value;
    const passwordInput = document.getElementById("password").value;

    fetch('/api/auth/login', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username: usernameInput,
            password: passwordInput
        })
    })
    .then(res => res.json().then(data => ({ status: res.status, data })))
    .then(({ status, data }) => {
        if (status === 200) {

            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('generar-rutina-section').classList.remove('hidden');

        } else {
            alert(data.error || 'Error de login');
        }
    });
}



function register() {
    const usernameInput = document.getElementById("username_register").value;
    const passwordInput = document.getElementById("password_register").value;

    fetch("/api/auth/registro", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: usernameInput,
            password: passwordInput
        })
    })
    .then(() => showLogin());
}


function logout() {
    fetch('/api/auth/logout', {
        method: 'POST',
        credentials: "include"
    })
    .then(() => {

        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('register-section').classList.add('hidden');
        document.getElementById('generar-rutina-section').classList.add('hidden');
        document.getElementById('mostrar-rutina-section').classList.add('hidden');

    });
}


/* =======================
   RUTINAS
======================= */
function buscarRutinas() {
    fetch(`/api/rutinas/base?objetivo=${objetivo.value}&nivel=${nivel.value}&dias=${dias.value}`)
    .then(r => r.json())
    .then(data => {
        rutinasDisponibles = data;
        pintarListado(data);
    });
}

function pintarListado(rutinas) {
    listado_rutinas.innerHTML = "";
    if (!rutinas.length) {
        listado_rutinas.innerHTML = "<p>No hay rutinas disponibles</p>";
        return;
    }
    rutinas.forEach(r => {
        listado_rutinas.innerHTML += `
            <div>
                <strong>${r.nombre}</strong><br>
                <button onclick="verRutina(${r.id})">Ver</button>
                <button onclick="guardarRutina(${r.id})">Guardar</button>
            </div>
        `;
    });
}

function verRutina(id) {
    const rutina = rutinasDisponibles.find(r => r.id === id);
    if (!rutina) return;

    rutinaSeleccionadaId = id;
    pintarRutina(rutina.rutina_json);
    generar_rutina_section.classList.add("hidden");
    mostrar_rutina_section.classList.remove("hidden");
}

function pintarRutina(rutina) {
    tabla_rutina.innerHTML = "";
    rutina.dias.forEach(dia => {
        dia.ejercicios.forEach(ej => {
            tabla_rutina.innerHTML += `
                <tr>
                    <td>Día ${dia.dia}</td>
                    <td>${ej.nombre}</td>
                    <td>${ej.series}</td>
                    <td>${ej.reps}</td>
                </tr>`;
        });
    });
}

function guardarRutina(id = rutinaSeleccionadaId) {
    fetch("/api/rutinas/usuario", {
        method: "POST",
        credentials: "include",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({rutina_base_id: id})
    })
    .then(() => alert("Rutina guardada"));
}

/* =======================
   NAVEGACIÓN
======================= */
function showLogin() {
    document.getElementById('login-section').classList.remove('hidden');
    document.getElementById('register-section').classList.add('hidden');
    document.getElementById('generar-rutina-section').classList.add('hidden');
    document.getElementById('mostrar-rutina-section').classList.add('hidden');
}


function showRegister() {
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('register-section').classList.remove('hidden');
    document.getElementById('generar-rutina-section').classList.add('hidden');
    document.getElementById('mostrar-rutina-section').classList.add('hidden');
}


function showBusqueda() {
    login_section.classList.add("hidden");
    register_section.classList.add("hidden");
    generar_rutina_section.classList.remove("hidden");
}

function volverBusqueda() {
    mostrar_rutina_section.classList.add("hidden");
    generar_rutina_section.classList.remove("hidden");
}
</script>

</body>
</html>
